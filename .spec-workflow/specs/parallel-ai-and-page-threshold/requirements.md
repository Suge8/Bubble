# 需求文档

## 引言（Introduction）

本规格旨在增强运行时体验：
- 并行提问：已添加的 AI 窗口保持活跃，允许用户在多个窗口中并行进行问答，后台窗口的会话与网络请求不中断。
- 页面数量放开：允许打开超过 5 个页面；当页面数从 4 增加到 5 时弹出一次性 Toast 提示“页面较多可能占用内存导致卡顿”（本地化），不阻断用户继续操作，也不提供任何相关设置项。

## 与产品愿景的对齐（Alignment）

该功能提升多平台、多会话的流畅性与连贯性：
- 在并行使用场景下保持响应与稳定，减少因切换窗口造成的中断与等待。
- 以“轻提示、零干扰”的方式告知资源风险，避免配置负担与不必要的复杂度。

## 功能性需求（Requirements）

### 需求 1：并行 AI 会话（窗口保持活跃）

用户故事：作为重度用户，我希望在打开多个 AI 窗口时，已有窗口保持活跃，这样后台对话可以持续处理，我可以在其它窗口继续工作。

验收标准（Acceptance Criteria）：
1. 当用户新开一个 AI 窗口时，既有窗口的进行中请求应继续执行，不得自动重载或被挂起。
2. 当用户在多个窗口之间切换焦点时，失焦窗口不得被销毁或重建；其会话状态与 UI 应保持不变。
3. 当后台窗口存在长时请求（例如流式输出/长推理）且用户切换到其他窗口时，该请求应在后台正常完成，无需用户额外干预。
4. 当且仅当用户关闭窗口时，才释放该窗口的相关资源；非异常情况下不得主动暂停后台 WebView。
5. 若后台窗口发生错误（如网络失败），应仅在该窗口内显示标准错误 UI，不影响其他窗口。

### 需求 2：页面数量阈值 Toast（非阻断）

用户故事：作为普通用户，我希望在打开较多页面时收到轻提示，从而意识到内存与卡顿风险，但不被阻止继续操作，也无需修改设置。

验收标准（Acceptance Criteria）：
1. 当活动页面数从 4 变化为 5 时，应显示 Toast：“页面较多可能占用内存导致卡顿”（需本地化），约 3 秒后自动消失。
2. 当页面数继续超过 5（如 6、7…）时，不应再次显示与页面阈值相关的 Toast（即单次触发基于从 4→5 的跃迁）。
3. 当页面数之后降至小于 5，再次增加到 5 时，应再次显示该 Toast（再次发生 4→5 的跃迁即再次触发）。
4. Toast 必须为非阻断式提示（非模态）；不得包含“本次会话不再提示”等交互；设置页中不得提供任何与该阈值或提示相关的开关或选项。
5. 阈值固定为 5；允许继续打开超过 5 个页面，不得阻止点击或新增。

## 非功能性需求（Non-Functional Requirements）

### 架构与模块化
- 单一职责：窗口生命周期管理与 UI 通知分离；页面计数与 Toast 触发逻辑封装为独立模块（或管理器）。
- 模块化：统一的页面计数观察与 Toast 触发接口，避免各处重复实现。
- 清晰接口：提供简洁的增加/减少页面计数入口与 Toast 触发点，便于后续扩展。
- 外观监听工具化：将系统外观变更监听（如 effectiveAppearance 的 KVO、应用级通知）封装为工具，统一注册/注销与回调分发，降低重复代码与退出阶段的泄漏/崩溃风险。

### 性能
- 切换焦点不应触发不必要的重载或重建。
- 复用 WKProcessPool 与会话上下文，保证并行场景下的网络连续性。
- Toast 渲染应轻量，避免明显的布局抖动或掉帧。

### 安全
- 无新增敏感权限或沙箱能力。
- 窗口间仅共享现有会话范围的数据，不扩大数据可见性。

### 可靠性
- 观察者（页面计数、外观等）在销毁时应可确定性清理，避免内存泄漏与异常回调。
- 后台活动不得干扰前台交互与渲染。

### 易用性
- Toast 文案需本地化，自动消失，无需用户操作。
- 不引入任何设置项，默认行为清晰、可预期。