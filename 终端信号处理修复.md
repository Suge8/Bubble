# BubbleBot 终端信号处理修复

## 问题描述
原来的 BubbleBot 启动后，在终端按 Ctrl+C 无法正常退出，显示为 `^C^C^C` 但程序继续运行。

## 根本原因
macOS 应用的 `app.run()` 方法会启动一个完全阻塞的事件循环，接管所有输入处理，包括终端的 Ctrl+C 信号。

## 解决方案

### 1. 替换事件循环机制
- **之前**: 使用 `app.run()` 阻塞式事件循环
- **现在**: 使用 `NSRunLoop` 手动控制事件循环，配合退出标志

### 2. 信号处理改进
- 设置全局 `exit_requested` 标志
- 信号处理器直接设置退出标志，不尝试调用 NSApp

### 3. 定时检查机制
- 在 AppDelegate 中添加定时器，定期检查退出标志
- 检测到退出请求时，优雅关闭应用

## 测试步骤

### 第一步：测试新的信号处理机制
```bash
cd /Users/sugeh/Documents/Project/Bubble-Bot
source .venv/bin/activate
python3 test_signal.py
```

**预期结果**：
- 显示测试窗口
- 在终端按 Ctrl+C 应该立即退出
- 不再显示 `^C^C^C`，而是显示退出消息

### 第二步：测试修复后的 BubbleBot
```bash
python3 BubbleBot.py
```

**预期结果**：
- 显示 BubbleBot 主窗口
- 在终端按 Ctrl+C 能正常退出
- 不会阻塞终端

## 技术细节

### 修改的文件

1. **src/bubblebot/main.py**
   - 添加 `exit_requested` 全局标志
   - 简化信号处理器
   - 替换 `app.run()` 为手动事件循环

2. **src/bubblebot/app.py**
   - 添加退出检查定时器
   - 实现 `checkExitStatus_` 方法

### 关键代码改动

```python
# 手动事件循环替代 app.run()
while not exit_requested:
    run_loop = NSRunLoop.currentRunLoop()
    run_loop.runMode_beforeDate_(NSDefaultRunLoopMode, 
                               NSDate.dateWithTimeIntervalSinceNow_(0.1))
    if exit_requested:
        break
```

```python
# 定时检查退出状态
self.exit_check_timer = NSTimer.scheduledTimerWithTimeInterval_target_selector_userInfo_repeats_(
    0.5, self, 'checkExitStatus:', None, True
)
```

## 验证方法

1. **启动应用**：应该能正常显示窗口
2. **Ctrl+C 测试**：在终端按 Ctrl+C，应该立即显示退出消息并关闭
3. **功能测试**：窗口功能应该正常工作
4. **重复测试**：可以反复启动和退出，不会阻塞终端

## 如果仍有问题

如果修复后还是无法用 Ctrl+C 退出：

1. **检查进程**：`ps aux | grep python`
2. **强制终止**：`killall python3`
3. **重启终端**
4. **检查权限**：确保没有权限提示窗口被阻塞

## 下一步优化

修复退出功能后，可以继续优化：
1. 恢复原来的无边框设计
2. 恢复透明效果
3. 恢复浮动窗口特性
4. 测试全局快捷键功能